<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mundane Fitness Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1?external=react,react-dom",
            "@dnd-kit/core": "https://esm.sh/@dnd-kit/core@6.0.8?external=react,react-dom",
            "@dnd-kit/sortable": "https://esm.sh/@dnd-kit/sortable@7.0.2?external=react,react-dom",
            "@dnd-kit/utilities": "https://esm.sh/@dnd-kit/utilities@3.2.1?external=react,react-dom"
        }
    }
    </script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        body { 
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior-y: none;
        }
    </style>
</head>
<body class="bg-[#050505] text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Play, Pause, Settings, X, Eye, Loader2, Shuffle,
          Calendar, Zap, Clock, Dumbbell, Volume2, VolumeX,
          SkipForward, SkipBack, Activity, Menu, RotateCcw, GripVertical
        } from 'lucide-react';
        import { DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors, DragOverlay } from '@dnd-kit/core';
        import { arrayMove, SortableContext, sortableKeyboardCoordinates, verticalListSortingStrategy, useSortable } from '@dnd-kit/sortable';
        import { CSS } from '@dnd-kit/utilities';

        function SortableItem(props) {
            const {
                attributes,
                listeners,
                setNodeRef,
                transform,
                transition,
                isDragging
            } = useSortable({ id: props.id });

            const style = {
                transform: CSS.Transform.toString(transform),
                transition,
                zIndex: isDragging ? 50 : 'auto',
                opacity: isDragging ? 0.5 : 1,
            };

            return (
                <div ref={setNodeRef} style={style} className={`flex items-center gap-2 p-3 rounded border text-sm transition-colors ${props.isActive ? 'bg-zinc-800 border-lime-500/30 text-white' : 'bg-zinc-900 border-transparent text-zinc-500 hover:bg-zinc-800/50 hover:text-zinc-300'}`}>
                    <button {...attributes} {...listeners} className="touch-none cursor-grab active:cursor-grabbing text-zinc-600 hover:text-zinc-400">
                        <GripVertical className="w-4 h-4" />
                    </button>
                    <div onClick={props.onClick} className="flex-1 flex gap-2 cursor-pointer">
                         <span className="font-mono text-xs opacity-50 pt-0.5">{props.index + 1}.</span>
                         <span className="truncate flex-1">{props.name}</span>
                    </div>
                </div>
            );
        }

        function ExerciseModal({ exercise, onClose, onJumpTo }) {
             if (!exercise) return null;
             return (
                 <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur flex items-center justify-center p-4" onClick={onClose}>
                     <div className="bg-zinc-900 border border-white/10 rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl" onClick={e => e.stopPropagation()}>
                         <div className="p-4 border-b border-white/10 flex justify-between items-center bg-zinc-900/50">
                             <div>
                                 <h2 className="text-2xl font-bold text-white">{exercise.name}</h2>
                                 <p className="text-zinc-400 text-sm">{exercise.instructions}</p>
                             </div>
                             <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-full"><X className="w-6 h-6" /></button>
                         </div>
                         <div className="flex-1 overflow-auto bg-black flex items-center justify-center p-4">
                              <img src={`assets/infographics/${exercise.key}.png`} onError={e => e.target.src=`assets/infographics/${exercise.key}.jpg`} className="max-w-full max-h-[60vh] object-contain" />
                         </div>
                         <div className="p-4 border-t border-white/10 flex justify-between items-center bg-zinc-900">
                             <div className="flex gap-4">
                                  <div className="flex flex-col">
                                      <span className="text-[10px] text-zinc-500 uppercase tracking-widest">Muscle</span>
                                      <span className="text-lime-400 font-mono">{exercise.muscle}</span>
                                  </div>
                                  <div className="flex flex-col">
                                      <span className="text-[10px] text-zinc-500 uppercase tracking-widest">Type</span>
                                      <span className="text-white font-mono">{exercise.angle}</span>
                                  </div>
                             </div>
                             <button onClick={() => { onJumpTo(); onClose(); }} className="px-6 py-3 bg-lime-500 text-black font-bold rounded-lg hover:bg-lime-400 flex items-center gap-2">
                                 <Play className="w-4 h-4 fill-black" /> START NOW
                             </button>
                         </div>
                     </div>
                 </div>
             );
        }


        function SettingsModal({ isOpen, onClose, userProfile, setUserProfile, protocols, schedule, setSchedule, onShuffle }) {
             if (!isOpen) return null;
             
             return (
                 <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur flex items-center justify-center p-4" onClick={onClose}>
                     <div className="bg-zinc-900 border border-white/10 rounded-2xl w-full max-w-lg max-h-[90vh] overflow-hidden flex flex-col shadow-2xl" onClick={e => e.stopPropagation()}>
                         <div className="p-4 border-b border-white/10 flex justify-between items-center bg-zinc-900/50">
                             <h2 className="text-xl font-bold text-white flex items-center gap-2">
                                <Settings className="w-5 h-5 text-lime-500" /> SETTINGS
                             </h2>
                             <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-full"><X className="w-6 h-6" /></button>
                         </div>
                         <div className="flex-1 overflow-y-auto p-6 space-y-6">
                             
                             {/* Profile Selection */}
                             <div className="space-y-3">
                                 <h3 className="text-xs font-mono text-zinc-500 uppercase tracking-widest">User Profile</h3>
                                 <div className="grid grid-cols-2 gap-3">
                                     <button onClick={() => setUserProfile('man')} className={`py-4 px-6 rounded-xl border transition-all ${userProfile === 'man' ? 'bg-zinc-800 border-lime-500 text-white shadow-[0_0_15px_-5px_rgba(132,204,22,0.3)]' : 'border-zinc-800 text-zinc-500 hover:border-zinc-700'}`}>
                                         <div className="font-bold mb-1">Man</div>
                                         <div className="text-xs opacity-60">Strength Focus</div>
                                     </button>
                                     <button onClick={() => setUserProfile('woman')} className={`py-4 px-6 rounded-xl border transition-all ${userProfile === 'woman' ? 'bg-zinc-800 border-lime-500 text-white shadow-[0_0_15px_-5px_rgba(132,204,22,0.3)]' : 'border-zinc-800 text-zinc-500 hover:border-zinc-700'}`}>
                                         <div className="font-bold mb-1">Woman</div>
                                         <div className="text-xs opacity-60">Toning Focus</div>
                                     </button>
                                 </div>
                             </div>

                             {/* Weekly Schedule */}
                             <div className="space-y-3">
                                  <h3 className="text-xs font-mono text-zinc-500 uppercase tracking-widest">Weekly Schedule</h3>
                                  <div className="grid grid-cols-1 gap-2">
                                      {schedule.map((proto, i) => (
                                          <div key={i} className="flex items-center gap-3 bg-black/40 p-3 rounded-lg border border-white/5">
                                              <span className="w-8 text-zinc-500 font-mono text-xs">{['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][i]}</span>
                                              <select 
                                                 value={proto}
                                                 onChange={(e) => {
                                                     const newSchedule = [...schedule];
                                                     newSchedule[i] = e.target.value;
                                                     setSchedule(newSchedule);
                                                     localStorage.setItem(`mundane_fitness_schedule_${userProfile}`, JSON.stringify(newSchedule));
                                                 }}
                                                 className="flex-1 bg-transparent text-white text-sm rounded outline-none"
                                              >
                                                  {Object.keys(protocols).map(k => <option key={k} value={k} className="bg-zinc-900">{k}</option>)}
                                              </select>
                                          </div>
                                      ))}
                                  </div>
                              </div>
                         </div>
                     </div>
                 </div>
             );
        }
        // ONE TIME ONLY: Clear assets for new generation batch
        const PROFILES = {
            man: {
                config: { restTime: 60, rounds: 3, setRestTime: 10 }, // Long rest, 3 sets
                assets: [
                    'incline_db_press', 'flat_db_press', 'incline_db_fly', 'flat_db_fly',
                    'seated_shoulder_press', 'chest_supported_row', 'one_arm_row',
                    'incline_bicep_curl', 'seated_bicep_curl', 'skull_crushers',
                    'db_pullover', 'bulgarian_split_squat', 'seated_rear_delt_fly',
                    'step_ups', 'spider_curl', 'overhead_tricep_ext', 'concentration_curl',
                    'bench_dips', 'prone_reverse_fly', 'prone_row', 'single_arm_incline_press',
                    'seated_shrugs', 'goblet_squat_bench', 'seated_calf_raise', 'arnold_press',
                    'lateral_raises', 'hammer_curls', 'romanian_deadlift_male', 'lunges_male'
                ],
                library: {
                    'incline_db_press': { name: "Incline DB Press", angle: "45째 Incline", instructions: "Press DBs up, meeting in center.", key: 'incline_db_press', muscle: "Upper Chest", duration: 75 },
                    'flat_db_press': { name: "Flat DB Press", angle: "Flat", instructions: "Press vertically from chest level.", key: 'flat_db_press', muscle: "Chest", duration: 75 },
                    'incline_db_fly': { name: "Incline DB Fly", angle: "45째 Incline", instructions: "Wide arc motion for upper chest stretch.", key: 'incline_db_fly', muscle: "Upper Chest", duration: 60 },
                    'flat_db_fly': { name: "Flat DB Fly", angle: "Flat", instructions: "Open wide, squeeze chest at top.", key: 'flat_db_fly', muscle: "Chest", duration: 60 },
                    'seated_shoulder_press': { name: "Seated Shoulder Press", angle: "Upright", instructions: "Press DBs overhead.", key: 'seated_shoulder_press', muscle: "Shoulders", duration: 75 },
                    'chest_supported_row': { name: "Chest Supported Row", angle: "Incline", instructions: "Lie face down, row DBs to hips.", key: 'chest_supported_row', muscle: "Back", duration: 75 },
                    'one_arm_row': { name: "One Arm Row", angle: "Flat Bench", instructions: "Support on bench, row one side.", key: 'one_arm_row', muscle: "Lats", duration: 75 },
                    'incline_bicep_curl': { name: "Incline Curl", angle: "45째 Incline", instructions: "Arms back, curl with biceps.", key: 'incline_bicep_curl', muscle: "Biceps", duration: 60 },
                    'seated_bicep_curl': { name: "Seated Curl", angle: "Upright", instructions: "Standard seated bicep curl.", key: 'seated_bicep_curl', muscle: "Biceps", duration: 60 },
                    'skull_crushers': { name: "DB Skullcrushers", angle: "Flat", instructions: "Lower DBs to ears, extend.", key: 'skull_crushers', muscle: "Triceps", duration: 60 },
                    'db_pullover': { name: "DB Pullover", angle: "Flat", instructions: "Arc DB behind head.", key: 'db_pullover', muscle: "Lats/Chest", duration: 60 },
                    'bulgarian_split_squat': { name: "Bulgarian Split Squat", angle: "Standing/Bench", instructions: "One foot back on bench, squat.", key: 'bulgarian_split_squat', muscle: "Quads/Glutes", duration: 90 },
                    'seated_rear_delt_fly': { name: "Seated Rear Fly", angle: "Seated", instructions: "Hinge forward, fly out to sides.", key: 'seated_rear_delt_fly', muscle: "Rear Delts", duration: 45 },
                    'step_ups': { name: "Step Ups", angle: "Standing/Bench", instructions: "Step up onto bench.", key: 'step_ups', muscle: "Legs", duration: 90 },
                    'spider_curl': { name: "Spider Curl", angle: "Incline Prone", instructions: "Prone on incline, curl forward.", key: 'spider_curl', muscle: "Biceps", duration: 60 },
                    'overhead_tricep_ext': { name: "Overhead Tricep Ext", angle: "Seated", instructions: "DB behind head, extend up.", key: 'overhead_tricep_ext', muscle: "Triceps", duration: 60 },
                    'concentration_curl': { name: "Concentration Curl", angle: "Seated", instructions: "Elbow on thigh, isolate bicep.", key: 'concentration_curl', muscle: "Biceps", duration: 60 },
                    'bench_dips': { name: "Bench Dips", angle: "Bench", instructions: "Hands on bench, lower body.", key: 'bench_dips', muscle: "Triceps", duration: 60 },
                    'prone_reverse_fly': { name: "Prone Reverse Fly", angle: "Incline Prone", instructions: "Face down, fly for rear delts.", key: 'prone_reverse_fly', muscle: "Rear Delts", duration: 60 },
                    'prone_row': { name: "Prone Row", angle: "Incline Prone", instructions: "Face down, row elbows back.", key: 'prone_row', muscle: "Back", duration: 75 },
                    'single_arm_incline_press': { name: "1-Arm Incline Press", angle: "Incline", instructions: "Press one side at a time.", key: 'single_arm_incline_press', muscle: "Chest", duration: 60 },
                    'seated_shrugs': { name: "Seated Shrugs", angle: "Upright", instructions: "Shrug shoulders to ears.", key: 'seated_shrugs', muscle: "Traps", duration: 60 },
                    'goblet_squat_bench': { name: "Goblet Squat to Bench", angle: "Standing/Bench", instructions: "Squat until touching bench.", key: 'goblet_squat_bench', muscle: "Quads", duration: 90 },
                    'seated_calf_raise': { name: "Seated Calf Raise", angle: "Seated", instructions: "DBs on knees, raise heels.", key: 'seated_calf_raise', muscle: "Calves", duration: 75 },
                    'arnold_press': { name: "Arnold Press", angle: "Seated", instructions: "Rotate palms as you press.", key: 'arnold_press', muscle: "Shoulders", duration: 75 },
                    'lateral_raises': { name: "DB Lateral Raises", angle: "Standing", instructions: "Raise arms to sides until parallel.", key: 'lateral_raises', muscle: "Side Delts", duration: 60 },
                    'hammer_curls': { name: "Hammer Curls", angle: "Standing", instructions: "Curl with neutral grip.", key: 'hammer_curls', muscle: "Biceps/Forearms", duration: 60 },
                    'romanian_deadlift_male': { name: "Romanian Deadlift", angle: "Standing", instructions: "Hinge hips back, keep legs straightish.", key: 'romanian_deadlift_male', muscle: "Hamstrings", duration: 75 },
                    'lunges_male': { name: "Walking Lunges", angle: "Standing", instructions: "Step forward, drop back knee.", key: 'lunges_male', muscle: "Legs", duration: 75 },
                    'cardio_walk': { name: "Rest / Walk", angle: "N/A", instructions: "Active recovery or rest.", key: 'cardio_walk', muscle: "Cardio", duration: 300 }
                },
                protocols: {
                    'Push A': ['incline_db_press', 'seated_shoulder_press', 'overhead_tricep_ext', 'bench_dips', 'flat_db_fly'],
                    'Push B': ['flat_db_press', 'arnold_press', 'skull_crushers', 'incline_db_fly', 'seated_shrugs'],
                    'Push C': ['seated_shoulder_press', 'incline_db_fly', 'bench_dips', 'seated_shrugs', 'flat_db_press'],
                    'Pull A': ['chest_supported_row', 'incline_bicep_curl', 'spider_curl', 'prone_reverse_fly', 'db_pullover'],
                    'Pull B': ['one_arm_row', 'seated_bicep_curl', 'concentration_curl', 'seated_rear_delt_fly', 'prone_row'],
                    'Pull C': ['one_arm_row', 'spider_curl', 'prone_reverse_fly', 'db_pullover', 'seated_bicep_curl'],
                    'Legs':   ['bulgarian_split_squat', 'goblet_squat_bench', 'step_ups', 'seated_calf_raise', 'cardio_walk'],
                    'Legs B': ['step_ups', 'bulgarian_split_squat', 'seated_calf_raise', 'goblet_squat_bench', 'cardio_walk'],
                    'Rest':   ['cardio_walk'] 
                },
                defaultSchedule: ['Push A', 'Pull A', 'Legs', 'Push B', 'Pull B', 'Push A', 'Rest']
            },
            woman: {
                config: { restTime: 30, rounds: 4, setRestTime: 10 }, // Short rest, 4 circuits
                assets: [
                    'goblet_squat_female', 'lunges_female', 'kneeling_pushups_female', 'one_arm_row_female', 'overhead_press_female',
                    'pelvic_tilts_female', 'dead_bug_female', 'bird_dog_female', 'glute_bridges_female', 'clamshells_female',
                    'wall_sit_female', 'scapular_slides_female', 'cat_cow_female', 'childs_pose_female', 'standing_knee_raise_female',
                    'romanian_deadlift_female', 'donkey_kicks_female', 'superman_female', 'side_lying_leg_lift_female', 'plank_female',
                    'side_plank_female', 'russian_twists_female', 'jumping_jacks_female', 'mountain_climbers_female', 'step_ups_female', 'squat_jumps_female'
                ],
                library: {
                   'goblet_squat_female': { name: "Goblet Squat", angle: "Standing", instructions: "Hold weight at chest, squat down.", key: 'goblet_squat_female', muscle: "Quads/Core", duration: 45 },
                   'kneeling_pushups_female': { name: "Modified Pushups", angle: "Floor", instructions: "Knees on mat, keep back straight.", key: 'kneeling_pushups_female', muscle: "Chest/Core", duration: 45 },
                   'one_arm_row_female': { name: "One Arm Row", angle: "Bench", instructions: "Support on bench, row weight to hip.", key: 'one_arm_row_female', muscle: "Back", duration: 45 },
                   'overhead_press_female': { name: "Seated Press", angle: "Seated", instructions: "Press weights overhead, core tight.", key: 'overhead_press_female', muscle: "Shoulders", duration: 45 },
                   'glute_bridges_female': { name: "Glute Bridges", angle: "Floor", instructions: "Lift hips, squeeze glutes at top.", key: 'glute_bridges_female', muscle: "Glutes/Core", duration: 45 },
                   
                   'standing_knee_raise_female': { name: "High Knees", angle: "Standing", instructions: "March in place, lifting knees high.", key: 'standing_knee_raise_female', muscle: "Cardio", duration: 60 },
                   'bird_dog_female': { name: "Bird Dog", angle: "Floor", instructions: "Extend opposite arm and leg.", key: 'bird_dog_female', muscle: "Core Stability", duration: 45 },
                   'dead_bug_female': { name: "Dead Bug", angle: "Floor", instructions: "Lower opposite arm/leg, keep back flat.", key: 'dead_bug_female', muscle: "Deep Core", duration: 45 },
                   'pelvic_tilts_female': { name: "Pelvic Tilts", angle: "Floor", instructions: "Tilt pelvis to flatten lower back.", key: 'pelvic_tilts_female', muscle: "Core", duration: 45 },
                   
                   'cat_cow_female': { name: "Cat Cow", angle: "Floor", instructions: "Arch and round spine gently.", key: 'cat_cow_female', muscle: "Mobility", duration: 60 },
                   'childs_pose_female': { name: "Child's Pose", angle: "Floor", instructions: "Sit back on heels, reach forward.", key: 'childs_pose_female', muscle: "Stretch", duration: 60 },
                   'scapular_slides_female': { name: "Wall Slides", angle: "Wall", instructions: "Back to wall, slide arms in 'W'.", key: 'scapular_slides_female', muscle: "Posture", duration: 45 },
                   
                   'lunges_female': { name: "Walking Lunges", angle: "Standing", instructions: "Step forward, lower back knee.", key: 'lunges_female', muscle: "Legs", duration: 45 },
                   'wall_sit_female': { name: "Wall Sit", angle: "Wall", instructions: "Sit against wall, knees at 90째.", key: 'wall_sit_female', muscle: "Quads", duration: 45 },
                   'clamshells_female': { name: "Clamshells", angle: "Floor", instructions: "Side lying, open top knee.", key: 'clamshells_female', muscle: "Hips/Glutes", duration: 45 },

                   'romanian_deadlift_female': { name: "Romanian Deadlift", angle: "Standing", instructions: "Hinge hips back, back straight.", key: 'romanian_deadlift_female', muscle: "Hamstring/Glute", duration: 45 },
                   'donkey_kicks_female': { name: "Donkey Kicks", angle: "Floor", instructions: "Kick leg back/up.", key: 'donkey_kicks_female', muscle: "Glutes", duration: 45 },
                   'superman_female': { name: "Superman", angle: "Floor", instructions: "Lift arms and legs.", key: 'superman_female', muscle: "Lower Back", duration: 45 },
                   'side_lying_leg_lift_female': { name: "Side Leg Lift", angle: "Floor", instructions: "Lift top leg.", key: 'side_lying_leg_lift_female', muscle: "Hips", duration: 45 },
                   'plank_female': { name: "Plank", angle: "Floor", instructions: "Hold plank position.", key: 'plank_female', muscle: "Core", duration: 60 },
                   'side_plank_female': { name: "Side Plank", angle: "Floor", instructions: "Hold side plank.", key: 'side_plank_female', muscle: "Obliques", duration: 45 },
                   'russian_twists_female': { name: "Russian Twists", angle: "Seated", instructions: "Twist torso.", key: 'russian_twists_female', muscle: "Obliques", duration: 45 },
                   'jumping_jacks_female': { name: "Jumping Jacks", angle: "Standing", instructions: "Jump wide.", key: 'jumping_jacks_female', muscle: "Cardio", duration: 60 },
                   'mountain_climbers_female': { name: "Mountain Climbers", angle: "Floor", instructions: "Drive knees to chest.", key: 'mountain_climbers_female', muscle: "Cardio", duration: 45 },
                   'step_ups_female': { name: "Step Ups", angle: "Standing", instructions: "Step up on box.", key: 'step_ups_female', muscle: "Legs", duration: 60 },
                   'squat_jumps_female': { name: "Squat Jumps", angle: "Standing", instructions: "Squat and jump.", key: 'squat_jumps_female', muscle: "Cardio/Legs", duration: 45 },

                   'cardio_walk': { name: "Rest / Walk", angle: "N/A", instructions: "Active recovery or rest.", key: 'cardio_walk', muscle: "Cardio", duration: 300 }
                },
                protocols: {
                    'Strength A': ['goblet_squat_female', 'kneeling_pushups_female', 'one_arm_row_female', 'overhead_press_female', 'glute_bridges_female'],
                    'Cardio Core': ['standing_knee_raise_female', 'bird_dog_female', 'dead_bug_female', 'pelvic_tilts_female', 'cardio_walk'],
                    'Rest Flow': ['cat_cow_female', 'childs_pose_female', 'scapular_slides_female', 'glute_bridges_female', 'cardio_walk'],
                    'Strength B': ['lunges_female', 'wall_sit_female', 'clamshells_female', 'scapular_slides_female', 'kneeling_pushups_female'],
                    'Strength C': ['romanian_deadlift_female', 'donkey_kicks_female', 'superman_female', 'side_lying_leg_lift_female', 'plank_female'],
                    'Strength D': ['plank_female', 'side_plank_female', 'russian_twists_female', 'bird_dog_female', 'dead_bug_female'],
                    'Strength E': ['jumping_jacks_female', 'mountain_climbers_female', 'step_ups_female', 'squat_jumps_female', 'standing_knee_raise_female'],
                    'Active Rec': ['cardio_walk', 'cat_cow_female', 'childs_pose_female'],
                    'Rest': ['cardio_walk']
                },
                defaultSchedule: ['Strength A', 'Cardio Core', 'Rest Flow', 'Strength B', 'Cardio Core', 'Active Rec', 'Rest']
            }
        };

        function ExerciseVisual({ exerciseKey, assets }) {
            const hasAsset = assets.includes(exerciseKey);

            if (!hasAsset && exerciseKey !== 'cardio_walk') {
               return (
                 <div className="w-full h-full bg-zinc-900 flex flex-col items-center justify-center text-zinc-600 font-mono gap-2 p-4 text-center relative">
                    <Loader2 className="animate-spin" />
                    <span className="text-xs">ASSET NOT FOUND: {exerciseKey}</span>
                 </div>
               );
            }

            // Fallback for cardio
            if (exerciseKey === 'cardio_walk') {
                return (
                     <div className="w-full h-full bg-zinc-900 flex items-center justify-center">
                        <div className="flex flex-col items-center gap-4 animate-pulse">
                            <Clock className="text-lime-500 w-24 h-24" />
                            <span className="text-zinc-500 font-mono text-sm uppercase tracking-widest">Walk Time</span>
                        </div>
                     </div>
                );
            }

            const isFemale = exerciseKey.includes('female');
            // Hacky way to detect file extension, assuming new ones are .png from generation tool usually, 
            // but the original code used .jpg. Let's support both or standardized. 
            // The generated files are .png. The old files were .jpg
            // Implementation: We will use a function or try/catch. Or simpler:
            // Since I know which are which:
            const ext = isFemale ? 'png' : 'jpg';
            // Actually, the original code had .jpg. The new artifacts are .png. 
            // Better to just support png for new ones.

            return (
                <div className="relative w-full h-full flex items-center justify-center bg-black overflow-hidden group">
                     <div className="w-full h-full flex items-center justify-center p-8">
                          <img 
                             src={`assets/infographics/${exerciseKey}.${ext}`} 
                             onError={(e) => {
                                 // Fallback to other extension if needed or show error
                                 if (e.target.src.endsWith('.png')) {
                                     e.target.src = e.target.src.replace('.png', '.jpg');
                                 } else {
                                     e.target.style.display='none'; 
                                     e.target.parentNode.innerText='INFOGRAPHIC MISSING';
                                 }
                             }}
                             className="w-full h-full object-contain border border-lime-500/30 rounded-lg shadow-[0_0_30px_-10px_rgba(132,204,22,0.3)]" 
                             alt="Infographic"
                          />
                     </div>
                </div>
            );
        }

        function App() {
          const [dayIdx] = useState(new Date().getDay());
          
          // Profile State
          const [userProfile, setUserProfile] = useState(() => {
              return localStorage.getItem('mundane_fitness_profile') || 'man';
          });

          // Derived Data based on Profile
          const activeProfileData = PROFILES[userProfile];
          const protocols = activeProfileData.protocols;
          const exerciseLibrary = activeProfileData.library;
          const availableAssets = activeProfileData.assets;
          const activeConfig = activeProfileData.config || { restTime: 45, rounds: 1 }; // Default if missing

          const [schedule, setSchedule] = useState(() => {
            const saved = localStorage.getItem(`mundane_fitness_schedule_${userProfile}`); 
            return saved ? JSON.parse(saved) : activeProfileData.defaultSchedule;
          });

          // Reset schedule if profile changes
          useEffect(() => {
              const saved = localStorage.getItem(`mundane_fitness_schedule_${userProfile}`);
              if (saved) {
                  setSchedule(JSON.parse(saved));
              } else {
                  setSchedule(activeProfileData.defaultSchedule);
              }
          }, [userProfile]);



          const [forceProtocol, setForceProtocol] = useState(null);
          const activeProtocolType = forceProtocol || schedule[dayIdx];
          
          // GENERATE ROUTINE LIST WITH ROUNDS
          const baseRoutineKeys = protocols[activeProtocolType] || protocols['Rest'];
          
          const [customRoutine, setCustomRoutine] = useState(null);
          const [selectedExercise, setSelectedExercise] = useState(null); // For Modal

          // Reset custom routine on protocol change
          useEffect(() => {
              setCustomRoutine(null);
          }, [activeProtocolType]);

          // Flatten routine based on rounds (Except for Rest which is 1 round)
          const activeRoutineKeys = useMemo(() => {
               if (customRoutine) return customRoutine;
               return baseRoutineKeys || [];
          }, [baseRoutineKeys, customRoutine]);

          const sensors = useSensors(
              useSensor(PointerSensor),
              useSensor(KeyboardSensor, {
                  coordinateGetter: sortableKeyboardCoordinates,
              })
          );

          function handleDragEnd(event) {
              const {active, over} = event;
              
              if (active.id !== over.id) {
                  const oldIndex = activeRoutineKeys.indexOf(active.id);
                  const newIndex = activeRoutineKeys.indexOf(over.id);
                  setCustomRoutine(arrayMove(activeRoutineKeys, oldIndex, newIndex));
              }
          }

          
          const TARGET_ROUNDS = activeConfig.rounds || 1;
          const EXERCISE_REST = activeConfig.restTime || 60;
          const SET_REST = activeConfig.setRestTime || 10;
          const REST_DURATION = EXERCISE_REST; // Fallback ref

          const [currentStep, setCurrentStep] = useState(0);
          const [currentSet, setCurrentSet] = useState(0);
          const [phase, setPhase] = useState('WORK'); // 'WORK', 'REST_SET', 'REST_EXERCISE'
          
          const [timeLeft, setTimeLeft] = useState(0);
          const [isRunning, setIsRunning] = useState(false);
          const [isResting, setIsResting] = useState(false); 
          const [showSettings, setShowSettings] = useState(false);

          const [isMuted, setIsMuted] = useState(false);
          const audioRef = useRef(null); 
          const bgAudioRef = useRef(null); // Background Keep-Alive Audio 
          
          // Ensure voices are loaded and pick English
          const [voice, setVoice] = useState(null);
          
          const selectBestVoice = () => {
              const all = window.speechSynthesis.getVoices();
              // Priority: "Premium" -> "Enhanced" -> "Google" -> Default
              const best = all.find(v => v.name.includes("Premium") && v.lang.startsWith("en")) ||
                           all.find(v => v.name.includes("Enhanced") && v.lang.startsWith("en")) ||
                           all.find(v => v.name.includes("Google") && v.lang.startsWith("en")) ||
                           all.find(v => v.lang.startsWith("en-US")) ||
                           all.find(v => v.lang.startsWith("en"));
              if (best) setVoice(best);
              return best;
          };

          const [debugLog, setDebugLog] = useState([]);
          const addToLog = (msg) => setDebugLog(prev => [msg, ...prev].slice(0, 5));
          const [debugMsgs, setDebugMsgs] = useState([]);

          const addDebug = (msg) => setDebugMsgs(prev => [msg, ...prev].slice(0, 50));

          useEffect(() => {
              const loadVoices = () => {
                  const voices = window.speechSynthesis.getVoices();
                  addDebug(`Voices loaded: ${voices.length}`);
                  
                  if (voices.length > 0) {
                      // Try to find Google US English, or any English, or just the first one
                      const bestVoice = voices.find(v => v.name.includes("Google US English")) || 
                                        voices.find(v => v.lang.startsWith("en")) || 
                                        voices[0];
                      setVoice(bestVoice);
                      addDebug(`Selected: ${bestVoice ? bestVoice.name : 'None'}`);
                  } else {
                      addDebug("No voices found yet.");
                  }
              };

              loadVoices();
              // window.speechSynthesis.onvoiceschanged = loadVoices; // DISABLED: Preventing Re-render flood
              
              // Try to load voices again after a delay (iOS quirk)
              setTimeout(selectBestVoice, 1000);
              
              // Fallback: Retry every second for 5 seconds if no voices
              const i = setInterval(() => {
                  if (window.speechSynthesis.getVoices().length === 0) loadVoices();
                  else clearInterval(i);
              }, 1000);
              
              return () => clearInterval(i);
          }, []);

          // Playlist Definition
          // Playlist: Using reliable test URLs to avoid NotSupportedError
          const PLAYLIST = [
              { url: 'https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3', title: "Ethereal Flow", artist: "Pixabay" },
              { url: 'https://cdn.pixabay.com/download/audio/2022/11/22/audio_febc508520.mp3', title: "Power Pulse", artist: "Pixabay" },
              { url: 'https://cdn.pixabay.com/download/audio/2022/03/24/audio_34b79bcf95.mp3', title: "Deep Focus", artist: "Pixabay" },
              { url: 'https://cdn.pixabay.com/download/audio/2022/01/18/audio_d0a13f69d2.mp3', title: "Night Run", artist: "Pixabay" },
              
          ];

          const [playlist, setPlaylist] = useState(() => {
              // Fisher-Yates Shuffle on init
              const list = [...PLAYLIST];
              for (let i = list.length - 1; i > 0; i--) {
                  const j = Math.floor(Math.random() * (i + 1));
                  [list[i], list[j]] = [list[j], list[i]];
              }
              return list;
          });
          const [currentTrackIdx, setCurrentTrackIdx] = useState(0);

          // Audio Logic
          useEffect(() => {
              if (audioRef.current) {
                  // Only change source if the track index actually changed or it's first load
                  const currentSrc = audioRef.current.getAttribute('src');
                  const nextSrc = playlist[currentTrackIdx].url;
                  
                  if (currentSrc !== nextSrc) {
                      audioRef.current.src = nextSrc;
                      if (isRunning && !isMuted) {
                          audioRef.current.play().catch(e => console.log("Audio play failed:", e));
                      }
                  } else {
                      // Same source, just toggle play state
                      if (isRunning && !isMuted) {
                          audioRef.current.play().catch(e => console.log("Audio play failed:", e));
                      } else {
                          audioRef.current.pause();
                      }
                  }
              }
          }, [isRunning, isMuted, currentTrackIdx]); 
          
          const nextTrack = () => {
              setCurrentTrackIdx(prev => (prev + 1) % playlist.length);
          };

          const prevTrack = () => {
              setCurrentTrackIdx(prev => (prev - 1 + playlist.length) % playlist.length);
          };

          const shufflePlaylist = () => {
              setPlaylist(prev => {
                  const list = [...prev];
                  for (let i = list.length - 1; i > 0; i--) {
                      const j = Math.floor(Math.random() * (i + 1));
                      [list[i], list[j]] = [list[j], list[i]];
                  }
                  return list;
              });
              setCurrentTrackIdx(0); // Reset to first song of new order
          };

          const [isSidebarOpen, setIsSidebarOpen] = useState(false);


          // Re-trigger play if muted toggled while running
          useEffect(() => {
             if(audioRef.current) {
                 audioRef.current.volume = 0.3; // Set default volume to 30%
             }
          }, []);

          // Main Timer Loop

          // Helper for current exercise duration
          useEffect(() => {
              if (phase === 'WORK' && !isRunning && timeLeft === 0) {
                  // Initialize time for new step/set
                  const key = activeRoutineKeys[currentStep];
                  if (key) {
                      setTimeLeft(exerciseLibrary[key]?.duration || 45);
                  }
              }
          }, [currentStep, phase, activeRoutineKeys, isRunning]);

          // Main Timer Loop
          useEffect(() => {
            let interval = null;
            if (isRunning && timeLeft > 0) {
              interval = setInterval(() => {
                  setTimeLeft(prev => {
                      const newValue = prev - 1;
                      if ([3, 2, 1].includes(newValue)) speak(["One", "Two", "Three"][newValue - 1]);
                      return newValue;
                  });
              }, 1000);
            } else if (timeLeft === 0 && isRunning) {
               // PHASE TRANSITION LOGIC
               if (phase === 'WORK') {
                   playBeep();
                   if (currentSet < TARGET_ROUNDS - 1) {
                       // Go to SET REST
                       setPhase('REST_SET');
                       setIsResting(true);
                       setTimeLeft(SET_REST);
                       speak("Rest.");
                   } else {
                       // Done with all sets -> Go to EXERCISE REST (or Finish)
                       if (currentStep < activeRoutineKeys.length - 1) {
                           setPhase('REST_EXERCISE');
                           setIsResting(true);
                           setTimeLeft(EXERCISE_REST);
                           const nextName = exerciseLibrary[activeRoutineKeys[currentStep + 1]]?.name || "Next Exercise";
                           speak(`Exercise usage complete. Recover. Next up: ${nextName}`);
                       } else {
                           finishWorkout();
                       }
                   }
               } else if (phase === 'REST_SET') {
                   // Back to Work (Next Set)
                   playBeep();
                   setCurrentSet(prev => prev + 1);
                   setPhase('WORK');
                   setIsResting(false);
                   const exDuration = exerciseLibrary[activeRoutineKeys[currentStep]]?.duration || 45;
                   setTimeLeft(exDuration);
                   speak(`Set ${currentSet + 2}`);
               } else if (phase === 'REST_EXERCISE') {
                   // Next Exercise
                   playBeep();
                   setCurrentStep(prev => prev + 1);
                   setCurrentSet(0);
                   setPhase('WORK');
                   setIsResting(false);
                   const nextKey = activeRoutineKeys[currentStep + 1];
                   if (nextKey) {
                       const ex = exerciseLibrary[nextKey];
                       setTimeLeft(ex.duration);
                       speak(ex.name);
                   }
               }
            }
            return () => clearInterval(interval);
          }, [isRunning, timeLeft, phase, currentSet, currentStep, TARGET_ROUNDS, activeRoutineKeys]);

          const finishWorkout = () => {
              setIsRunning(false);
              speak("Great job! Workout complete.");
          };

          const handleStepComplete = () => {
              // Manual Advance (Skip)
              if (currentStep < activeRoutineKeys.length - 1) {
                  if (isResting) {
                      // Skip Rest -> Go to Work
                      setIsResting(false);
                      setCurrentSet(0);
                      setCurrentStep(prev => prev + 1);
                      const nextKey = activeRoutineKeys[currentStep + 1];
                      const nextEx = exerciseLibrary[nextKey];
                      setTimeLeft(nextEx.duration);
                  } else {
                      // Skip Work -> Go to Next Work (Skip rest too? Or go to rest?)
                      // User interaction implies "Done with this", lets go to Rest
                      setIsResting(true);
                      setTimeLeft(REST_DURATION);
                  }
              } else {
                  finishWorkout();
              }
          };
          
          const skipStep = () => {
              handleStepComplete();
          };



          // Simplified "User Snippet" style speak with beep
          const speak = (text) => {
              // 1. Always Beep (it works)
              playBeep();
              
              // 2. Simple Speak
              const synth = window.speechSynthesis;
              synth.cancel(); // Always clear pending to prevent queue pileup

              const u = new SpeechSynthesisUtterance(text);
              u.volume = 1.0;
              u.rate = 1.0; // Normal rate
              if (voice) u.voice = voice; // Use the "Premium" voice we found

              // Music Ducking
              if (audioRef.current && isRunning && !isMuted) {
                   audioRef.current.volume = 0.1;
              }
              
              u.onend = () => {
                   window._lastUtterance = null;
                   addToLog("Speak: End");
                   if (audioRef.current && isRunning && !isMuted) {
                        // Restore volume gently
                        audioRef.current.volume = 0.3;
                   }
              }
              u.onstart = () => addToLog(`Speak: Start (${text.substring(0,8)}...)`);
              u.onerror = (e) => addToLog(`Speak: Err ${e.error}`);
              
              window._lastUtterance = u; // CRITICAL: PREVENT GC
              synth.speak(u);
          };
          
          const toggleWorkout = () => {
              if (!isRunning) {
                  if (timeLeft <= 0) {
                      const ex = exerciseLibrary[activeRoutineKeys[currentStep]];
                      if (ex) setTimeLeft(ex.duration);
                  }
                  
                  // Resume context (CRITICAL FOR iOS)
                  window.speechSynthesis.resume();
                  
                  // Ensure we have a clean slate
                  if (window._audioDisabled) {
                      // Do nothing (Debug mode)
                  } else if (audioRef.current && !isMuted) {
                      audioRef.current.play().catch(e => console.log("Audio resume failed", e));
                  }
                  
                  // Start Background Keep-Alive
                  if (bgAudioRef.current) { 
                      bgAudioRef.current.play().catch(e => console.log("BG Audio failed", e)); 
                  }
                  
                  speak("Starting session.");
              } else {
                  // Pausing
                  window.speechSynthesis.cancel();
                  if (audioRef.current) audioRef.current.pause();
              }
              setIsRunning(!isRunning);
          };
          
          // Safety Beep using Web Audio API (Fallback)
          const playBeep = () => {
              try {
                  const ctx = new (window.AudioContext || window.webkitAudioContext)();
                  const osc = ctx.createOscillator();
                  const gain = ctx.createGain();
                  osc.connect(gain);
                  gain.connect(ctx.destination);
                  osc.frequency.value = 880; // High beep
                  gain.gain.value = 0.1;
                  osc.start();
                  setTimeout(() => {
                      osc.stop();
                      ctx.close();
                  }, 200);
                  addDebug("Beep played");
              } catch (e) {
                  addDebug(`Beep failed: ${e}`);
              }
          };

          const testVoiceBasic = () => {
              addDebug("Test: Basic (Window Store)");
              playBeep(); // Prove audio context works
              
              window.speechSynthesis.cancel();
              const u = new SpeechSynthesisUtterance("Testing.");
              u.volume = 1.0;
              u.onstart = () => addDebug("Event: Start");
              u.onend = () => addDebug("Event: End");
              u.onerror = (e) => addDebug(`Event: Err ${e.error}`);
              
              // GLOBAL STORAGE TO PREVENT GC
              window._lastUtterance = u;
              
              window.speechSynthesis.speak(u);
          };

          const testVoiceForced = () => {
              addDebug("Test: Forced (Window Store)");
              const s = window.speechSynthesis;
              s.cancel();
              s.resume();
              
              const u = new SpeechSynthesisUtterance("Forced test.");
              // Don't set voice - let browser default
              u.onstart = () => addDebug("Event: Start");
              u.onerror = (e) => addDebug(`Event: Err ${e.error}`);
              
              window._lastUtterance = u;
              s.speak(u);
          };
          
          const testVoiceDirect = () => {
              addDebug("Test: Direct (Reset+Speak)");
              window.speechSynthesis.cancel();
              
              const u = new SpeechSynthesisUtterance("Direct.");
              window._lastUtterance = u;
              window.speechSynthesis.speak(u);
          };

          const handlePreview = (index) => {
              if (isRunning) return; 
              setCurrentStep(index);
              setCurrentSet(0);
              setIsResting(false); 
              // Immediate time update
              const ex = exerciseLibrary[activeRoutineKeys[index]];
              if (ex) setTimeLeft(ex.duration);
          };

          const shuffleRoutine = () => {
              const allKeys = Object.keys(protocols).filter(k => k !== 'Rest');
              // Basic safety if no keys
              if (allKeys.length === 0) return;

              let next = activeProtocolType;
              // Try to pick a new one, avoid infinite loop if only 1 exists
              if (allKeys.length > 1) {
                  while (next === activeProtocolType || next === 'Rest') {
                      next = allKeys[Math.floor(Math.random() * allKeys.length)];
                  }
              } else {
                  next = allKeys[0];
              }
              
              setForceProtocol(next);
              
              // Reset State
              setIsRunning(false);
              setIsResting(false);
              setCurrentStep(0);
              
              // Set time for new first exercise
              const firstKey = protocols[next][0];
              if (firstKey && exerciseLibrary[firstKey]) {
                  setTimeLeft(exerciseLibrary[firstKey].duration);
              }
              
              speak(`Switched to ${next}`);
          };

          const formatTime = (s) => {
            const min = Math.floor(s / 60);
            const sec = s % 60;
            return `${min}:${sec.toString().padStart(2, '0')}`;
          };

          const currentKey = activeRoutineKeys[currentStep];
          const currentEx = exerciseLibrary[currentKey] || exerciseLibrary['cardio_walk']; 
          
          // Determine Next Exercise for Display
          const nextKeyDisplay = (currentStep < activeRoutineKeys.length - 1) ? activeRoutineKeys[currentStep + 1] : null;
          const nextExDisplay = nextKeyDisplay ? exerciseLibrary[nextKeyDisplay] : null;

          const SidebarContent = (
              <div className="flex flex-col h-full bg-[#0a0a0a]">
                  {/* UP NEXT PREVIEW */}
                  <div className="p-4 border-b border-white/10 shrink-0">
                       <h3 className="text-xs font-mono text-zinc-500 uppercase tracking-widest mb-3 flex items-center gap-2"><Eye className="w-3 h-3" /> Up Next</h3>
                       {nextExDisplay ? (
                           <div className="flex gap-4 items-center group cursor-pointer bg-zinc-900/50 p-2 rounded-lg border border-white/5 hover:border-lime-500/30 transition-colors" onClick={() => setSelectedExercise(nextExDisplay)}>
                                <div className="w-16 h-16 bg-zinc-900 rounded overflow-hidden border border-white/10 shrink-0">
                                     <img src={`assets/infographics/${nextExDisplay.key}.png`} onError={e => e.target.src=`assets/infographics/${nextExDisplay.key}.jpg`} className="w-full h-full object-cover" />
                                </div>
                                <div className="flex-1 min-w-0">
                                     <div className="text-sm font-bold text-white truncate group-hover:text-lime-400 transition-colors">{nextExDisplay.name}</div>
                                     <div className="text-xs text-zinc-500 truncate">{nextExDisplay.muscle}</div>
                                     <div className="text-[10px] text-zinc-600 mt-1 uppercase">{nextExDisplay.angle}</div>
                                </div>
                           </div>
                       ) : (
                           <div className="text-zinc-500 text-sm italic p-2">Workout Finishing Soon</div>
                       )}
                  </div>

                  {/* DRAGGABLE LIST */}
                  <div className="flex-1 overflow-y-auto p-4 content-start">
                       <div className="flex items-center justify-between mb-3 sticky top-0 bg-[#0a0a0a] z-10 py-2 border-b border-white/5">
                           <h3 className="text-xs font-mono text-zinc-500 uppercase tracking-widest">Routine ({activeRoutineKeys.length})</h3>
                           <span className="text-[10px] text-zinc-600">Drag to Reorder</span>
                       </div>
                       
                       <DndContext sensors={sensors} collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
                           <SortableContext items={activeRoutineKeys} strategy={verticalListSortingStrategy}>
                               <div className="space-y-2 pb-10">
                                   {activeRoutineKeys.map((key, i) => {
                                       const isActive = i === currentStep;
                                       const ex = exerciseLibrary[key] || { name: key };
                                       return (
                                           <SortableItem 
                                               key={key} 
                                               id={key}
                                               index={i}
                                               isActive={isActive}
                                               name={ex.name}
                                               onClick={() => setSelectedExercise(ex)} 
                                           />
                                       );
                                   })}
                               </div>
                           </SortableContext>
                       </DndContext>
                  </div>

                  {/* FOOTER CONTROLS */}
                  <div className="border-t border-white/10 p-4 bg-zinc-900/30 shrink-0 space-y-4">
                       {/* Config */}
                       <div className="grid grid-cols-2 gap-2">
                           <div className="bg-zinc-900 border border-white/5 rounded px-2 flex items-center">
                                <select 
                                     className="w-full bg-transparent text-white text-[10px] outline-none h-8 font-mono uppercase"
                                     value={activeProtocolType} 
                                     onChange={(e) => {
                                         setForceProtocol(e.target.value);
                                         setIsRunning(false);
                                         setIsResting(false);
                                         setCurrentStep(0);
                                     }}
                                >
                                   {Object.keys(protocols).filter(k => k !== 'Rest').map(key => (
                                       <option key={key} value={key} className="bg-zinc-900">{key}</option>
                                   ))}
                                </select>
                           </div>
                           <button 
                                onClick={shuffleRoutine}
                                className="h-8 border border-zinc-700 rounded text-zinc-400 hover:text-white hover:border-lime-500 flex items-center justify-center gap-1 text-[10px] font-mono uppercase"
                            >
                                <Shuffle className="w-3 h-3" /> Mix
                            </button>
                       </div>
                       
                       {/* Audio */}
                       <div className="bg-black/50 p-2 rounded flex items-center justify-between">
                            <div className="overflow-hidden mr-2">
                               <div className="text-[10px] text-zinc-300 truncate font-mono">{playlist[currentTrackIdx].title}</div>
                            </div>
                            <div className="flex gap-2 shrink-0">
                                <button onClick={prevTrack}><SkipBack className="w-4 h-4 text-zinc-500 hover:text-white" /></button>
                                <button onClick={() => { if(audioRef.current) audioRef.current.paused ? audioRef.current.play() : audioRef.current.pause(); }}>
                                    <Activity className="w-4 h-4 text-lime-500 hover:text-lime-400" />
                                </button>
                                <button onClick={nextTrack}><SkipForward className="w-4 h-4 text-zinc-500 hover:text-white" /></button>
                            </div>
                       </div>
                  </div>
              </div>
          );

          return (
            <div className="h-[100dvh] w-screen bg-[#050505] text-white font-sans flex flex-col overflow-hidden supports-[height:100dvh]:h-[100dvh]">
              <audio ref={audioRef} onEnded={nextTrack} />
              <audio ref={bgAudioRef} loop src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAASAA82xUAAAAAAA//OEZAAAAAAIAAAAAAAAEAAABAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//OEZAAAAAAIAAAAAAAAEAAABAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" />
              

              <ExerciseModal exercise={selectedExercise} onClose={() => setSelectedExercise(null)} onJumpTo={() => { 
                  const idx = activeRoutineKeys.indexOf(selectedExercise.key);
                  if (idx !== -1) handlePreview(idx);
              }} />

              <SettingsModal 
                  isOpen={showSettings} 
                  onClose={() => setShowSettings(false)}
                  userProfile={userProfile}
                  setUserProfile={setUserProfile}
                  protocols={protocols}
                  schedule={schedule}
                  setSchedule={setSchedule}
              />

              {/* TOP BAR - Sticky Source of Truth */}
              <div className="flex items-center justify-between px-4 py-3 border-b border-white/10 shrink-0 bg-[#050505] z-30">
                <div className="flex items-center gap-3">
                  <div className="bg-lime-500/10 p-2 rounded-lg"><Dumbbell className="text-lime-500 w-5 h-5" /></div>
                  <div>
                      <h1 className="text-lg font-bold tracking-tight text-white leading-none">MUNDANE</h1>
                      <div className="text-[10px] text-zinc-500 font-mono tracking-widest">{userProfile.toUpperCase()} // {activeProtocolType.toUpperCase()}</div>
                  </div>
                </div>
                
                <div className="flex items-center gap-2">
                    <button onClick={() => setShowSettings(true)} className="p-2 text-zinc-400 hover:text-lime-500 transition-colors">
                        <Settings className="w-6 h-6" />
                    </button>
                    <button onClick={() => setIsSidebarOpen(true)} className="lg:hidden p-2 text-zinc-400 hover:text-white"><Menu className="w-6 h-6" /></button>
                </div>
              </div>

              {/* MAIN CONTENT ROW */}
              <div className="flex-1 flex overflow-hidden relative">
                
                {/* LEFT: MAIN WORKOUT AREA */}
                <div className="flex-1 flex flex-col relative min-w-0">
                   {/* VISUAL & OVERLAY */}
                   <div className="flex-1 relative overflow-hidden bg-zinc-900 flex flex-col items-center justify-center">
                      <div className="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.02)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.02)_1px,transparent_1px)] bg-[size:40px_40px]"></div>
                      <div className="w-full h-full p-4 lg:p-8 relative z-10 flex items-center justify-center">
                          <ExerciseVisual exerciseKey={currentKey} assets={availableAssets} />
                      </div>


                      
                      {/* MOBILE UP NEXT (Split View) */}
                      {nextExDisplay && !isResting && (
                          <div 
                              className="lg:hidden w-full bg-black border-t border-white/10 shrink-0 p-4 flex items-center gap-4 cursor-pointer hover:bg-zinc-900 transition-colors animate-in slide-in-from-bottom-10 fade-in duration-500"
                              onClick={() => setSelectedExercise(nextExDisplay)}
                          >
                               <div className="w-16 h-16 bg-zinc-800 rounded-lg overflow-hidden shrink-0 border border-white/10 relative">
                                   <img src={`assets/infographics/${nextExDisplay.key}.png`} onError={e => e.target.src=`assets/infographics/${nextExDisplay.key}.jpg`} className="w-full h-full object-cover" />
                                   <div className="absolute inset-0 bg-black/20"></div>
                               </div>
                               <div className="flex-col min-w-0 flex items-start">
                                    <span className="text-[10px] text-lime-500 font-mono uppercase tracking-widest mb-1">Up Next</span>
                                    <span className="text-lg font-bold text-white leading-tight truncate w-full text-left">{nextExDisplay.name}</span>
                                    <span className="text-xs text-zinc-500">{nextExDisplay.muscle}</span>
                               </div>
                          </div>
                      )}
                      
                      {isResting && (
                          <div className="absolute inset-0 bg-black z-20 flex items-center justify-center animate-in fade-in duration-300">
                               <div className="flex flex-col items-center gap-2">
                                   <div className="text-[200px] leading-none font-black text-lime-500 font-mono tabular-nums tracking-tighter mix-blend-screen opacity-90">
                                       {timeLeft}
                                   </div>
                                   <div className="text-2xl font-bold text-white tracking-widest uppercase">{phase === 'REST_SET' ? 'Rest Between Sets' : 'Recover'}</div>
                               </div>
                          </div>
                      )}
                   </div>

                   {/* BOTTOM BAR - STICKY */}
                   <div className="shrink-0 bg-[#050505] border-t border-white/10 p-4 lg:p-6 flex items-center gap-4 lg:gap-8 z-30 shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
                       <button 
                         onClick={toggleWorkout}
                         className={`w-16 h-16 rounded-2xl flex items-center justify-center transition-all shadow-lg ${isRunning ? 'bg-zinc-800 text-red-500 border border-red-500/20' : 'bg-lime-500 text-black hover:bg-lime-400 hover:scale-105'}`}
                       >
                           {isRunning ? <Pause className="w-8 h-8 fill-current" /> : <Play className="w-8 h-8 fill-current ml-1" />}
                       </button>

                       <div className="flex-1 bg-zinc-900/50 rounded-xl border border-white/5 p-3 flex items-center justify-between px-6">
                           <div className="flex flex-col">
                               <span className="text-[10px] font-mono text-zinc-500 uppercase tracking-widest mb-1">Current</span>
                               <span className="text-xl lg:text-3xl font-bold text-white truncate max-w-[120px] lg:max-w-md">{currentEx.name}</span>
                           </div>

                           <div className="flex items-center gap-8 lg:gap-12">
                               <div className="flex flex-col items-center">
                                   <span className="text-[10px] font-mono text-zinc-500 uppercase tracking-widest mb-1">Set</span>
                                   <div className="flex items-center gap-2">
                                       <span className="text-2xl lg:text-3xl font-mono font-black text-white">{currentSet + 1}<span className="text-zinc-600 text-lg">/{TARGET_ROUNDS}</span></span>
                                       <button onClick={() => setCurrentSet(0)} className="hover:bg-zinc-800 p-1 rounded transition-colors"><RotateCcw className="w-4 h-4 text-zinc-500" /></button>
                                   </div>
                               </div>
                               <div className="flex flex-col items-end">
                                   <span className="text-[10px] font-mono text-zinc-500 uppercase tracking-widest mb-1">Time</span>
                                   <span className={`text-4xl lg:text-5xl font-mono font-black tabular-nums tracking-tighter ${timeLeft <= 5 && isRunning ? 'text-red-500' : 'text-lime-500'}`}>{formatTime(timeLeft)}</span>
                               </div>
                           </div>
                       </div>
                       
                       <button onClick={skipStep} className="hidden md:flex h-16 w-16 items-center justify-center rounded-2xl bg-zinc-900 text-zinc-500 hover:text-white hover:bg-zinc-800 border border-white/5 transition-colors">
                           <SkipForward className="w-8 h-8" />
                       </button>
                   </div>
                </div>

                {/* RIGHT: SIDEBAR (DESKTOP) */}
                <div className="hidden lg:block w-96 border-l border-white/10 shrink-0 h-full overflow-hidden">
                    {SidebarContent}
                </div>

                {/* MOBILE DRAWER */}
                {isSidebarOpen && (
                    <div className="fixed inset-0 z-50 lg:hidden">
                        <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={() => setIsSidebarOpen(false)} />
                        <div className="absolute inset-y-0 right-0 w-80 bg-[#0a0a0a] border-l border-white/10 shadow-2xl flex flex-col">
                            <div className="p-4 border-b border-white/10 flex justify-end">
                                <button onClick={() => setIsSidebarOpen(false)}><X className="w-6 h-6 text-zinc-500" /></button>
                            </div>
                            <div className="flex-1 overflow-hidden">
                                {SidebarContent}
                            </div>
                        </div>
                    </div>
                )}

              </div>
            </div>
          );


        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
