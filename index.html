<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mundane Fitness Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        body { 
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior-y: none;
        }
    </style>
</head>
<body class="bg-[#050505] text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Play, Pause, Settings, X, Eye, Loader2, Shuffle,
          Calendar, Zap, Clock, Dumbbell, Volume2, VolumeX
        } from 'lucide-react';

        // ONE TIME ONLY: Clear assets for new generation batch
        const availableAssets = [
            'incline_db_press', 'flat_db_press', 'incline_db_fly', 'flat_db_fly',
            'seated_shoulder_press', 'chest_supported_row', 'one_arm_row',
            'incline_bicep_curl', 'seated_bicep_curl', 'skull_crushers',
            'db_pullover', 'bulgarian_split_squat', 'seated_rear_delt_fly',
            'step_ups', 'spider_curl', 'overhead_tricep_ext', 'concentration_curl',
            'bench_dips', 'prone_reverse_fly', 'prone_row', 'single_arm_incline_press',
            'seated_shrugs', 'goblet_squat_bench', 'seated_calf_raise', 'arnold_press'
        ]; 


        const exerciseLibrary = {
          'incline_db_press': { name: "Incline DB Press", angle: "45° Incline", instructions: "Press DBs up, meeting in center.", key: 'incline_db_press', muscle: "Upper Chest", duration: 600 },
          'flat_db_press': { name: "Flat DB Press", angle: "Flat", instructions: "Press vertically from chest level.", key: 'flat_db_press', muscle: "Chest", duration: 600 },
          'incline_db_fly': { name: "Incline DB Fly", angle: "45° Incline", instructions: "Wide arc motion for upper chest stretch.", key: 'incline_db_fly', muscle: "Upper Chest", duration: 450 },
          'flat_db_fly': { name: "Flat DB Fly", angle: "Flat", instructions: "Open wide, squeeze chest at top.", key: 'flat_db_fly', muscle: "Chest", duration: 450 },
          'seated_shoulder_press': { name: "Seated Shoulder Press", angle: "Upright", instructions: "Press DBs overhead.", key: 'seated_shoulder_press', muscle: "Shoulders", duration: 450 },
          'chest_supported_row': { name: "Chest Supported Row", angle: "Incline", instructions: "Lie face down, row DBs to hips.", key: 'chest_supported_row', muscle: "Back", duration: 450 },
          'one_arm_row': { name: "One Arm Row", angle: "Flat Bench", instructions: "Support on bench, row one side.", key: 'one_arm_row', muscle: "Lats", duration: 450 },
          'incline_bicep_curl': { name: "Incline Curl", angle: "45° Incline", instructions: "Arms back, curl with biceps.", key: 'incline_bicep_curl', muscle: "Biceps", duration: 450 },
          'seated_bicep_curl': { name: "Seated Curl", angle: "Upright", instructions: "Standard seated bicep curl.", key: 'seated_bicep_curl', muscle: "Biceps", duration: 450 },
          'skull_crushers': { name: "DB Skullcrushers", angle: "Flat", instructions: "Lower DBs to ears, extend.", key: 'skull_crushers', muscle: "Triceps", duration: 300 },
          'db_pullover': { name: "DB Pullover", angle: "Flat", instructions: "Arc DB behind head.", key: 'db_pullover', muscle: "Lats/Chest", duration: 450 },
          'bulgarian_split_squat': { name: "Bulgarian Split Squat", angle: "Standing/Bench", instructions: "One foot back on bench, squat.", key: 'bulgarian_split_squat', muscle: "Quads/Glutes", duration: 600 },
          'seated_rear_delt_fly': { name: "Seated Rear Fly", angle: "Seated", instructions: "Hinge forward, fly out to sides.", key: 'seated_rear_delt_fly', muscle: "Rear Delts", duration: 300 },
          'step_ups': { name: "Step Ups", angle: "Standing/Bench", instructions: "Step up onto bench.", key: 'step_ups', muscle: "Legs", duration: 600 },
          'spider_curl': { name: "Spider Curl", angle: "Incline Prone", instructions: "Prone on incline, curl forward.", key: 'spider_curl', muscle: "Biceps", duration: 450 },
          'overhead_tricep_ext': { name: "Overhead Tricep Ext", angle: "Seated", instructions: "DB behind head, extend up.", key: 'overhead_tricep_ext', muscle: "Triceps", duration: 300 },
          'concentration_curl': { name: "Concentration Curl", angle: "Seated", instructions: "Elbow on thigh, isolate bicep.", key: 'concentration_curl', muscle: "Biceps", duration: 450 },
          'bench_dips': { name: "Bench Dips", angle: "Bench", instructions: "Hands on bench, lower body.", key: 'bench_dips', muscle: "Triceps", duration: 300 },
          'prone_reverse_fly': { name: "Prone Reverse Fly", angle: "Incline Prone", instructions: "Face down, fly for rear delts.", key: 'prone_reverse_fly', muscle: "Rear Delts", duration: 300 },
          'prone_row': { name: "Prone Row", angle: "Incline Prone", instructions: "Face down, row elbows back.", key: 'prone_row', muscle: "Back", duration: 450 },
          'single_arm_incline_press': { name: "1-Arm Incline Press", angle: "Incline", instructions: "Press one side at a time.", key: 'single_arm_incline_press', muscle: "Chest", duration: 450 },
          'seated_shrugs': { name: "Seated Shrugs", angle: "Upright", instructions: "Shrug shoulders to ears.", key: 'seated_shrugs', muscle: "Traps", duration: 300 },
          'goblet_squat_bench': { name: "Goblet Squat to Bench", angle: "Standing/Bench", instructions: "Squat until touching bench.", key: 'goblet_squat_bench', muscle: "Quads", duration: 600 },
          'seated_calf_raise': { name: "Seated Calf Raise", angle: "Seated", instructions: "DBs on knees, raise heels.", key: 'seated_calf_raise', muscle: "Calves", duration: 300 },
          'arnold_press': { name: "Arnold Press", angle: "Seated", instructions: "Rotate palms as you press.", key: 'arnold_press', muscle: "Shoulders", duration: 450 },
          'cardio_walk': {
             name: "Rest / Walk",
             angle: "N/A",
             instructions: "Active recovery or rest.",
             key: 'cardio_walk',
             muscle: "Cardio",
             duration: 300
          }
        };

        const protocols = {
          'Push A': ['incline_db_press', 'seated_shoulder_press', 'overhead_tricep_ext', 'bench_dips', 'flat_db_fly'],
          'Push B': ['flat_db_press', 'arnold_press', 'skull_crushers', 'incline_db_fly', 'seated_shrugs'],
          'Pull A': ['chest_supported_row', 'incline_bicep_curl', 'spider_curl', 'prone_reverse_fly', 'db_pullover'],
          'Pull B': ['one_arm_row', 'seated_bicep_curl', 'concentration_curl', 'seated_rear_delt_fly', 'prone_row'],
          'Legs':   ['bulgarian_split_squat', 'goblet_squat_bench', 'step_ups', 'seated_calf_raise', 'cardio_walk'],
          'Rest':   ['cardio_walk'] 
        };

        function ExerciseVisual({ exerciseKey }) {
            const hasAsset = availableAssets.includes(exerciseKey);

            if (!availableAssets.includes(exerciseKey) && exerciseKey !== 'cardio_walk') {
               return (
                 <div className="w-full h-full bg-zinc-900 flex flex-col items-center justify-center text-zinc-600 font-mono gap-2 p-4 text-center relative">
                    <Loader2 className="animate-spin" />
                    <span className="text-xs">ASSET NOT FOUND: {exerciseKey}</span>
                 </div>
               );
            }

            // Fallback for cardio
            if (exerciseKey === 'cardio_walk') {
                return (
                     <div className="w-full h-full bg-zinc-900 flex items-center justify-center">
                        <div className="flex flex-col items-center gap-4 animate-pulse">
                            <Clock className="text-lime-500 w-24 h-24" />
                            <span className="text-zinc-500 font-mono text-sm uppercase tracking-widest">Walk Time</span>
                        </div>
                     </div>
                );
            }

            return (
                <div className="relative w-full h-full flex items-center justify-center bg-black overflow-hidden group">
                     <div className="w-full h-full flex items-center justify-center p-8">
                          <img 
                             src={`assets/infographics/${exerciseKey}.jpg`} 
                             onError={(e) => {e.target.style.display='none'; e.target.parentNode.innerText='INFOGRAPHIC MISSING'}}
                             className="w-full h-full object-contain border border-lime-500/30 rounded-lg shadow-[0_0_30px_-10px_rgba(132,204,22,0.3)]" 
                             alt="Infographic"
                          />
                     </div>
                </div>
            );
        }

        function App() {
          const [dayIdx] = useState(new Date().getDay());
          const [schedule, setSchedule] = useState(() => {
            const saved = localStorage.getItem('mundane_fitness_v5'); 
            return saved ? JSON.parse(saved) : ['Push A', 'Pull A', 'Legs', 'Push B', 'Pull B', 'Push A', 'Rest'];
          });

          const [forceProtocol, setForceProtocol] = useState(null);
          const activeProtocolType = forceProtocol || schedule[dayIdx];
          const activeRoutineKeys = protocols[activeProtocolType] || protocols['Rest'];
          
          const REST_DURATION = 45; // 45 seconds rest

          const [currentStep, setCurrentStep] = useState(0);
          const [timeLeft, setTimeLeft] = useState(0);
          const [isRunning, setIsRunning] = useState(false);
          const [isResting, setIsResting] = useState(false); // New Rest State
          const [showSettings, setShowSettings] = useState(false);

          const [isMuted, setIsMuted] = useState(false); // Music Mute State
          const audioRef = useRef(null); 
          
          // Ensure voices are loaded and pick English
          const [voice, setVoice] = useState(null);
          
          const selectBestVoice = () => {
              const all = window.speechSynthesis.getVoices();
              // Priority: "Premium" -> "Enhanced" -> "Google" -> Default
              const best = all.find(v => v.name.includes("Premium") && v.lang.startsWith("en")) ||
                           all.find(v => v.name.includes("Enhanced") && v.lang.startsWith("en")) ||
                           all.find(v => v.name.includes("Google") && v.lang.startsWith("en")) ||
                           all.find(v => v.lang.startsWith("en-US")) ||
                           all.find(v => v.lang.startsWith("en"));
              if (best) setVoice(best);
              return best;
          };

          const [debugLog, setDebugLog] = useState([]);
          const addToLog = (msg) => setDebugLog(prev => [msg, ...prev].slice(0, 5));
          const [debugMsgs, setDebugMsgs] = useState([]);

          const addDebug = (msg) => setDebugMsgs(prev => [msg, ...prev].slice(0, 50));

          useEffect(() => {
              const loadVoices = () => {
                  const voices = window.speechSynthesis.getVoices();
                  addDebug(`Voices loaded: ${voices.length}`);
                  
                  if (voices.length > 0) {
                      // Try to find Google US English, or any English, or just the first one
                      const bestVoice = voices.find(v => v.name.includes("Google US English")) || 
                                        voices.find(v => v.lang.startsWith("en")) || 
                                        voices[0];
                      setVoice(bestVoice);
                      addDebug(`Selected: ${bestVoice ? bestVoice.name : 'None'}`);
                  } else {
                      addDebug("No voices found yet.");
                  }
              };

              loadVoices();
              // window.speechSynthesis.onvoiceschanged = loadVoices; // DISABLED: Preventing Re-render flood
              
              // Try to load voices again after a delay (iOS quirk)
              setTimeout(selectBestVoice, 1000);
              
              // Fallback: Retry every second for 5 seconds if no voices
              const i = setInterval(() => {
                  if (window.speechSynthesis.getVoices().length === 0) loadVoices();
                  else clearInterval(i);
              }, 1000);
              
              return () => clearInterval(i);
          }, []);

          // Playlist Definition
          // Playlist: Using reliable test URLs to avoid NotSupportedError
          const PLAYLIST = [
              { url: 'https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3', title: "Ethereal Flow", artist: "Pixabay" },
              { url: 'https://cdn.pixabay.com/download/audio/2022/11/22/audio_febc508520.mp3', title: "Power Pulse", artist: "Pixabay" },
              { url: 'https://cdn.pixabay.com/download/audio/2022/03/24/audio_34b79bcf95.mp3', title: "Deep Focus", artist: "Pixabay" },
              { url: 'https://cdn.pixabay.com/download/audio/2022/01/18/audio_d0a13f69d2.mp3', title: "Night Run", artist: "Pixabay" },
              
          ];

          const [playlist, setPlaylist] = useState(() => {
              // Fisher-Yates Shuffle on init
              const list = [...PLAYLIST];
              for (let i = list.length - 1; i > 0; i--) {
                  const j = Math.floor(Math.random() * (i + 1));
                  [list[i], list[j]] = [list[j], list[i]];
              }
              return list;
          });
          const [currentTrackIdx, setCurrentTrackIdx] = useState(0);

          // Audio Logic
          useEffect(() => {
              if (audioRef.current) {
                  // Only change source if the track index actually changed or it's first load
                  const currentSrc = audioRef.current.getAttribute('src');
                  const nextSrc = playlist[currentTrackIdx].url;
                  
                  if (currentSrc !== nextSrc) {
                      audioRef.current.src = nextSrc;
                      if (isRunning && !isMuted) {
                          audioRef.current.play().catch(e => console.log("Audio play failed:", e));
                      }
                  } else {
                      // Same source, just toggle play state
                      if (isRunning && !isMuted) {
                          audioRef.current.play().catch(e => console.log("Audio play failed:", e));
                      } else {
                          audioRef.current.pause();
                      }
                  }
              }
          }, [isRunning, isMuted, currentTrackIdx]); 
          
          const nextTrack = () => {
              setCurrentTrackIdx(prev => (prev + 1) % playlist.length);
          };

          // Re-trigger play if muted toggled while running
          useEffect(() => {
             if(audioRef.current) {
                 audioRef.current.volume = 0.3; // Set default volume to 30%
             }
          }, []);

          // Main Timer Loop
          useEffect(() => {
            let interval = null;
            if (isRunning && timeLeft > 0) {
              interval = setInterval(() => {
                  setTimeLeft(prev => {
                      const newValue = prev - 1;
                      
                      // Speech Logic
                      if (newValue === 3 || newValue === 2 || newValue === 1) {
                         const words = {3: "Three", 2: "Two", 1: "One"};
                         speak(words[newValue]);
                      }
                      
                      return newValue;
                  });
              }, 1000);
            } else if (timeLeft === 0 && isRunning) {
               // Timer Hit Zero
               if (!isResting) {
                   // End of Workout -> Go to Rest
                   if (currentStep < activeRoutineKeys.length - 1) {
                        const nextKey = activeRoutineKeys[currentStep + 1];
                        const nextEx = exerciseLibrary[nextKey];
                        
                        setIsResting(true);
                        setTimeLeft(REST_DURATION);
                        // Speak Next Exercise Details NOW (Start of Rest)
                        speak(`Rest. Next up is ${nextEx.name}. ${nextEx.instructions}`);
                   } else {
                       finishWorkout();
                   }
               } else {
                   // End of Rest -> Go to Next Workout
                   speak("Begin.");
                   setIsResting(false);
                   setCurrentStep(prev => prev + 1);
                   const nextKey = activeRoutineKeys[currentStep + 1];
                   if (nextKey) {
                       const nextEx = exerciseLibrary[nextKey];
                       setTimeLeft(nextEx.duration);
                   }
               }
            }
            return () => clearInterval(interval);
          }, [isRunning, timeLeft, isResting, currentStep, activeRoutineKeys]);

          const finishWorkout = () => {
              setIsRunning(false);
              speak("Great job! Workout complete.");
          };

          const handleStepComplete = () => {
              // Manual Advance (Skip)
              if (currentStep < activeRoutineKeys.length - 1) {
                  if (isResting) {
                      // Skip Rest -> Go to Work
                      setIsResting(false);
                      setCurrentStep(prev => prev + 1);
                      const nextKey = activeRoutineKeys[currentStep + 1];
                      const nextEx = exerciseLibrary[nextKey];
                      setTimeLeft(nextEx.duration);
                  } else {
                      // Skip Work -> Go to Next Work (Skip rest too? Or go to rest?)
                      // User interaction implies "Done with this", lets go to Rest
                      setIsResting(true);
                      setTimeLeft(REST_DURATION);
                  }
              } else {
                  finishWorkout();
              }
          };
          
          const skipStep = () => {
              handleStepComplete();
          };



          // Simplified "User Snippet" style speak with beep
          const speak = (text) => {
              // 1. Always Beep (it works)
              playBeep();
              
              // 2. Simple Speak
              const synth = window.speechSynthesis;
              synth.cancel(); // Always clear pending to prevent queue pileup

              const u = new SpeechSynthesisUtterance(text);
              u.volume = 1.0;
              u.rate = 1.0; // Normal rate
              if (voice) u.voice = voice; // Use the "Premium" voice we found

              // Music Ducking
              if (audioRef.current && isRunning && !isMuted) {
                   audioRef.current.volume = 0.1;
              }
              
              u.onend = () => {
                   window._lastUtterance = null;
                   addToLog("Speak: End");
                   if (audioRef.current && isRunning && !isMuted) {
                        // Restore volume gently
                        audioRef.current.volume = 0.3;
                   }
              }
              u.onstart = () => addToLog(`Speak: Start (${text.substring(0,8)}...)`);
              u.onerror = (e) => addToLog(`Speak: Err ${e.error}`);
              
              window._lastUtterance = u; // CRITICAL: PREVENT GC
              synth.speak(u);
          };
          
          const toggleWorkout = () => {
              if (!isRunning) {
                  if (timeLeft <= 0) {
                      const ex = exerciseLibrary[activeRoutineKeys[currentStep]];
                      if (ex) setTimeLeft(ex.duration);
                  }
                  
                  // Resume context (CRITICAL FOR iOS)
                  window.speechSynthesis.resume();
                  
                  // Ensure we have a clean slate
                  if (window._audioDisabled) {
                      // Do nothing (Debug mode)
                  } else if (audioRef.current && !isMuted) {
                      audioRef.current.play().catch(e => console.log("Audio resume failed", e));
                  }
                  
                  speak("Starting session.");
              } else {
                  // Pausing
                  window.speechSynthesis.cancel();
                  if (audioRef.current) audioRef.current.pause();
              }
              setIsRunning(!isRunning);
          };
          
          // Safety Beep using Web Audio API (Fallback)
          const playBeep = () => {
              try {
                  const ctx = new (window.AudioContext || window.webkitAudioContext)();
                  const osc = ctx.createOscillator();
                  const gain = ctx.createGain();
                  osc.connect(gain);
                  gain.connect(ctx.destination);
                  osc.frequency.value = 880; // High beep
                  gain.gain.value = 0.1;
                  osc.start();
                  setTimeout(() => {
                      osc.stop();
                      ctx.close();
                  }, 200);
                  addDebug("Beep played");
              } catch (e) {
                  addDebug(`Beep failed: ${e}`);
              }
          };

          const testVoiceBasic = () => {
              addDebug("Test: Basic (Window Store)");
              playBeep(); // Prove audio context works
              
              window.speechSynthesis.cancel();
              const u = new SpeechSynthesisUtterance("Testing.");
              u.volume = 1.0;
              u.onstart = () => addDebug("Event: Start");
              u.onend = () => addDebug("Event: End");
              u.onerror = (e) => addDebug(`Event: Err ${e.error}`);
              
              // GLOBAL STORAGE TO PREVENT GC
              window._lastUtterance = u;
              
              window.speechSynthesis.speak(u);
          };

          const testVoiceForced = () => {
              addDebug("Test: Forced (Window Store)");
              const s = window.speechSynthesis;
              s.cancel();
              s.resume();
              
              const u = new SpeechSynthesisUtterance("Forced test.");
              // Don't set voice - let browser default
              u.onstart = () => addDebug("Event: Start");
              u.onerror = (e) => addDebug(`Event: Err ${e.error}`);
              
              window._lastUtterance = u;
              s.speak(u);
          };
          
          const testVoiceDirect = () => {
              addDebug("Test: Direct (Reset+Speak)");
              window.speechSynthesis.cancel();
              
              const u = new SpeechSynthesisUtterance("Direct.");
              window._lastUtterance = u;
              window.speechSynthesis.speak(u);
          };

          const handlePreview = (index) => {
              if (isRunning) return; 
              setCurrentStep(index);
              setIsResting(false); 
              // Immediate time update
              const ex = exerciseLibrary[activeRoutineKeys[index]];
              if (ex) setTimeLeft(ex.duration);
          };

          const shuffleRoutine = () => {
              const allKeys = Object.keys(protocols).filter(k => k !== 'Rest');
              // Basic safety if no keys
              if (allKeys.length === 0) return;

              let next = activeProtocolType;
              // Try to pick a new one, avoid infinite loop if only 1 exists
              if (allKeys.length > 1) {
                  while (next === activeProtocolType || next === 'Rest') {
                      next = allKeys[Math.floor(Math.random() * allKeys.length)];
                  }
              } else {
                  next = allKeys[0];
              }
              
              setForceProtocol(next);
              
              // Reset State
              setIsRunning(false);
              setIsResting(false);
              setCurrentStep(0);
              
              // Set time for new first exercise
              const firstKey = protocols[next][0];
              if (firstKey && exerciseLibrary[firstKey]) {
                  setTimeLeft(exerciseLibrary[firstKey].duration);
              }
              
              speak(`Switched to ${next}`);
          };

          const formatTime = (s) => {
            const min = Math.floor(s / 60);
            const sec = s % 60;
            return `${min}:${sec.toString().padStart(2, '0')}`;
          };

          const currentKey = activeRoutineKeys[currentStep];
          const currentEx = exerciseLibrary[currentKey] || exerciseLibrary['cardio_walk']; 
          
          // Determine Next Exercise for Display
          const nextKeyDisplay = (currentStep < activeRoutineKeys.length - 1) ? activeRoutineKeys[currentStep + 1] : null;
          const nextExDisplay = nextKeyDisplay ? exerciseLibrary[nextKeyDisplay] : null;

          return (
            <div className="min-h-screen bg-[#050505] text-white font-sans flex flex-col h-screen overflow-hidden">
              <audio 
                ref={audioRef} 
                onEnded={nextTrack}
              />
              
              <nav className="p-4 md:p-6 border-b border-zinc-900 flex justify-between items-center bg-[#050505]/95 z-20 shrink-0">
                <div>
                  <h1 className="text-xl md:text-2xl font-black italic text-lime-400 tracking-tighter">MUNDANE FITNESS</h1>
                  <div className="flex items-center gap-2 text-[10px] font-mono text-zinc-500 uppercase tracking-widest mt-1">
                    <Calendar size={12} className="text-zinc-700" />
                    {['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dayIdx]} // {activeProtocolType}
                  </div>
                </div>
                
                <div className="flex items-center gap-4">
                     {/* Shuffle Button */}
                     <div onClick={shuffleRoutine} className="p-2 bg-zinc-900 rounded-full cursor-pointer hover:bg-zinc-800 transition" title="Shuffle Routine">
                         <Shuffle size={18} className="text-lime-500" />
                     </div>

                     {/* Music Info */}
                     <div onClick={nextTrack} className="hidden md:flex items-center gap-2 px-3 py-1.5 bg-zinc-900 rounded-full cursor-pointer hover:bg-zinc-800 border border-zinc-800 group">
                        <div className={`w-2 h-2 rounded-full ${isRunning && !isMuted ? 'bg-lime-500 animate-pulse' : 'bg-zinc-600'}`}></div>
                        <div className="flex flex-col leading-none">
                            <span className="text-[10px] font-bold text-white max-w-[100px] truncate">{playlist[currentTrackIdx].title}</span>
                            <span className="text-[8px] text-zinc-500 max-w-[100px] truncate">{playlist[currentTrackIdx].artist}</span>
                        </div>
                        <Play size={10} className="text-zinc-500 ml-1 opacity-0 group-hover:opacity-100 transition-opacity" />
                     </div>

                     {/* Volume Toggle */}
                    <div onClick={() => setIsMuted(!isMuted)} className="p-2 bg-zinc-900 rounded-full cursor-pointer hover:bg-zinc-800 transition" title={isMuted ? "Unmute Music" : "Mute Music"}>
                        {isMuted ? <VolumeX size={18} className="text-zinc-600" /> : <Volume2 size={18} className="text-lime-500" />}
                    </div>

                    <div onClick={() => setShowSettings(true)} className="p-2 bg-zinc-900 rounded-full cursor-pointer hover:bg-zinc-800 transition">
                        <Settings size={18} />
                    </div>
                </div>
              </nav>

              <main className="flex-1 overflow-y-auto p-4 md:p-6 bg-[#050505]">
                <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
                  
                  <div className="lg:col-span-8 flex flex-col gap-6">
                    <div className="flex-1 bg-zinc-950 rounded-[2rem] border border-zinc-900 overflow-hidden relative flex flex-col md:flex-row shadow-2xl">
                        {/* Time Display: Relative/Block on Mobile (Top), Absolute on Desktop */}
                        <div className="w-full lg:w-auto bg-zinc-950/50 p-4 md:p-0 flex flex-col items-center justify-center md:block md:bg-transparent md:absolute md:top-6 md:right-6 md:z-10 md:text-right border-b border-zinc-900 md:border-0">
                           <div className={`text-6xl md:text-8xl font-black tabular-nums tracking-tighter drop-shadow-xl md:mix-blend-difference ${isResting ? 'text-lime-400' : 'text-white'}`}>
                             {formatTime(timeLeft)}
                           </div>
                           {isResting && <div className="text-lime-500 font-black uppercase tracking-widest text-sm animate-pulse">RESTING</div>}
                           
                           {/* Seek Slider */}
                           <input 
                              type="range"
                              min="0"
                              max={isResting ? REST_DURATION : (currentEx.duration)}
                              value={timeLeft}
                              onChange={(e) => setTimeLeft(parseInt(e.target.value))}
                              className="w-full md:w-32 lg:w-48 mt-2 accent-lime-500 bg-zinc-800 h-1 rounded-full appearance-none cursor-pointer opacity-50 hover:opacity-100 transition-opacity"
                              dir="rtl" 
                           />
                        </div>

                        <div className="flex-[3] bg-black flex items-center justify-center relative border-b md:border-b-0 md:border-r border-zinc-900 min-h-[50vh]">
                            {isResting ? (
                                <div className="flex flex-col items-center justify-center p-8 text-center max-w-sm">
                                    <div className="mb-4 p-4 bg-zinc-900/50 rounded-full">
                                      <Clock size={48} className="text-lime-500 animate-pulse" />
                                    </div>
                                    <h2 className="text-2xl font-black italic text-white mb-2">REST & RECOVER</h2>
                                    {nextExDisplay && (
                                        <div className="mt-4 p-4 border border-zinc-800 rounded-xl bg-zinc-950/50">
                                            <div className="text-[10px] uppercase text-zinc-500 tracking-widest mb-1">Coming Up Next</div>
                                            <div className="text-lime-400 font-bold text-lg">{nextExDisplay.name}</div>
                                            <div className="text-zinc-500 text-xs mt-1">{nextExDisplay.instructions}</div>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <ExerciseVisual exerciseKey={currentEx.key} />
                            )}
                        </div>

                        <div className="flex-1 p-6 flex flex-col justify-end gap-2 bg-zinc-950/80 backdrop-blur-sm border-t border-zinc-900">
                            <div>
                                <span className="bg-lime-500 text-black px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-wide">{currentEx.muscle}</span>
                                <h2 className="text-2xl md:text-4xl font-black italic uppercase leading-none mt-2 text-white">{currentEx.name}</h2>
                            </div>
                            
                            <div className="flex justify-between items-end">
                                <p className="text-zinc-400 text-xs leading-relaxed max-w-md line-clamp-2 md:line-clamp-none">
                                    {currentEx.instructions}
                                </p>
                            </div>

                            <div className="mt-2 flex gap-2">
                                <button onClick={handleStepComplete} className="flex-1 py-3 bg-white text-black font-black italic rounded-lg hover:bg-zinc-200 transition-colors flex items-center justify-center gap-2">
                                     DONE <span className="text-xs not-italic text-zinc-400">({currentStep + 1}/{activeRoutineKeys.length})</span>
                                </button>
                                <button onClick={() => setIsRunning(!isRunning)} className={`p-3 rounded-lg font-bold transition-colors ${isRunning ? 'bg-zinc-800 text-zinc-400' : 'bg-lime-500 text-black'}`}>
                                    {isRunning ? <Pause size={20} /> : <Play size={20} />}
                                </button>
                                <button onClick={skipStep} className="p-3 bg-zinc-800 text-white rounded-lg hover:bg-zinc-700 transition">
                                    <div className="flex items-center"><Play size={12} className="fill-current" /><Play size={12} className="fill-current -ml-1" /></div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="flex gap-4">
                        <button 
                          onClick={toggleWorkout}
                          className={`flex-1 py-6 md:py-8 rounded-[2rem] text-2xl font-black flex items-center justify-center gap-4 transition-all active:scale-95 ${isRunning ? 'bg-zinc-900 text-zinc-400 ring-2 ring-inset ring-zinc-800' : 'bg-lime-500 text-black shadow-[0_0_50px_-15px_rgba(132,204,22,0.5)]'}`}
                        >
                          {isRunning ? <Pause size={32} fill="currentColor" /> : <Play size={32} fill="currentColor" />}
                          {isRunning ? 'PAUSE' : 'START SESSION'}
                        </button>
                        
                        <button 
                            onClick={skipStep}
                            className="w-24 md:w-32 rounded-[2rem] bg-zinc-900 border border-zinc-800 flex items-center justify-center hover:bg-zinc-800 active:scale-95 transition-all group"
                        >
                            <div className="flex flex-col items-center gap-1">
                                <span className="text-zinc-500 group-hover:text-white"><Play size={24} fill="currentColor" className="ml-1" /></span>
                                <span className="text-[10px] font-bold uppercase text-zinc-600 tracking-widest">{isResting ? 'Start' : 'Skip'}</span>
                            </div>
                        </button>
                    </div>
                  </div>

                  {/* Up Next List */}
                  <div className="lg:col-span-4 bg-zinc-950 border border-zinc-900 rounded-[2rem] p-6 overflow-y-auto">
                    <h3 className="text-zinc-600 font-black uppercase tracking-widest text-xs mb-4 flex gap-2 items-center">
                        <Zap size={14} /> Workout Structure
                    </h3>
                    <div className="space-y-2">
                        {activeRoutineKeys.map((key, i) => {
                          const ex = exerciseLibrary[key];
                          const isActive = i === currentStep;
                          const isDone = i < currentStep;

                          if (!ex) return null;
                            
                          // Correct Time Formatting for List
                          const durationStr = `${Math.floor(ex.duration / 60)}:${(ex.duration % 60).toString().padStart(2, '0')}`;

                          return (
                            <div 
                              key={key + i}
                              onClick={() => handlePreview(i)}
                              className={`w-full text-left p-4 rounded-xl flex items-center gap-4 border transition-all cursor-pointer ${isActive ? 'bg-zinc-900 border-lime-500/50 scale-[1.02]' : 'border-transparent hover:bg-zinc-900/30'} ${isDone ? 'opacity-40' : 'opacity-100'}`}
                            >
                              <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-black ${isActive ? 'bg-lime-500 text-black' : isDone ? 'bg-zinc-800 text-zinc-600' : 'bg-zinc-800 text-zinc-400'}`}>
                                {i + 1}
                              </div>
                              <div className="flex-1">
                                <div className={`text-sm font-black uppercase ${isActive ? 'text-white' : 'text-zinc-500'}`}>{ex.name}</div>
                                <div className="text-[10px] text-zinc-600">{durationStr} • {ex.angle}</div>
                              </div>
                              {isActive && !isRunning && <span className="text-[10px] text-lime-500 font-bold uppercase tracking-wider">Up Next</span>}
                              {isActive && isRunning && isResting && <span className="text-[10px] text-lime-500 font-bold uppercase tracking-wider animate-pulse">Resting</span>}
                              {isActive && isRunning && !isResting && <span className="text-[10px] text-lime-500 animate-pulse font-bold uppercase tracking-wider">Active</span>}
                            </div>
                          );
                        })}
                    </div>
                  </div>

                </div>
              </main>

              {/* Settings Modal */}
              {showSettings && (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
                  <div className="bg-zinc-950 border border-zinc-800 p-8 rounded-[2rem] w-full max-w-md shadow-2xl">
                    <div className="flex justify-between items-center mb-6">
                      <h2 className="text-2xl font-black italic text-lime-400">Schedule</h2>
                      <button onClick={() => setShowSettings(false)}><X size={24} className="text-zinc-500" /></button>
                    </div>
                    <div className="space-y-2 mb-6 max-h-[60vh] overflow-y-auto">
                      {['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'].map((day, i) => (
                        <div key={day} className="flex justify-between items-center p-3 bg-zinc-900 rounded-xl">
                          <span className="text-xs font-bold text-zinc-400 uppercase">{day}</span>
                          <select 
                            value={schedule[i]}
                            onChange={(e) => {
                              const ns = [...schedule]; ns[i] = e.target.value; setSchedule(ns);
                              localStorage.setItem('mundane_fitness_v5', JSON.stringify(ns));
                            }}
                            className="bg-black text-white text-xs p-2 rounded-lg font-bold uppercase outline-none border border-zinc-800 focus:border-lime-500"
                          >
                            <option value="Rest">Rest</option>
                            <option value="Push A">Push A</option>
                            <option value="Push B">Push B</option>
                            <option value="Pull A">Pull A</option>
                            <option value="Pull B">Pull B</option>
                            <option value="Legs">Legs</option>
                          </select>
                        </div>
                      ))}
                    </div>
                    <div className="space-y-2 mb-6 max-h-[60vh] overflow-y-auto">

                        <div className="p-4 bg-zinc-900 rounded-xl mb-4">
                            <h3 className="text-zinc-400 text-xs font-bold uppercase mb-2">Debug Audio</h3>
                            <button 
                                onClick={() => {
                                    addToLog("Button Clicked..."); // 1. Immediate Feedback
                                    const synth = window.speechSynthesis;
                                    
                                    // 2. Unstick iOS
                                    synth.cancel();
                                    
                                    setTimeout(() => {
                                        if (synth.paused) synth.resume();
                                        
                                        const u = new SpeechSynthesisUtterance("Alpha Bravo Charlie.");
                                        u.rate = 0.9; // Slight slow down
                                        u.onstart = () => addToLog("Event: Start");
                                        u.onend = () => addToLog("Event: End");
                                        u.onerror = (e) => addToLog(`Event: Err ${e.error}`);
                                        
                                        synth.speak(u);
                                        addToLog("Cmd: Speak Sent");
                                    }, 50);
                                }}
                                className="w-full mb-2 p-3 bg-zinc-800 text-white font-bold rounded-lg text-xs"
                            >
                                TEST VOICE (FORCE)
                            </button>
                            <div className="text-[10px] font-mono text-lime-500 bg-black p-2 rounded h-20 overflow-y-auto">
                                {debugLog.length === 0 ? "No logs yet..." : debugLog.map((l, i) => <div key={i}>{l}</div>)}
                            </div>
                        </div>

                        <button onClick={() => setShowSettings(false)} className="w-full py-4 bg-zinc-100 text-black font-black rounded-xl hover:scale-[0.98] transition-transform">SAVE CHANGES</button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
